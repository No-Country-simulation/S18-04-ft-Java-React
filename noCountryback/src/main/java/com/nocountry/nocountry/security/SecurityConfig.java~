package com.nocountry.nocountry.security;


import com.nocountry.nocountry.security.filter.JwtAuthenticationFilter;
import com.nocountry.nocountry.security.oauth2.CustomOAuth2UserService;
import com.nocountry.nocountry.security.oauth2.HttpCookieOAuth2AuthorizationRequestRepository;
import com.nocountry.nocountry.security.oauth2.OAuth2AuthenticationFailureHandler;
import com.nocountry.nocountry.security.oauth2.OAuth2AuthenticationSuccessHandler;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpMethod;
import org.springframework.security.authentication.AuthenticationProvider;
import org.springframework.security.config.Customizer;
import org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.oauth2.client.registration.ClientRegistrationRepository;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

@Configuration
@EnableWebSecurity
@RequiredArgsConstructor
@EnableMethodSecurity(prePostEnabled = true)
public class SecurityConfig {

    private final static String OAUTH2_BASE_URI = "/api/auth/oauth2/authorize";
    private final static String OAUTH2_REDIRECTION_ENDPOINT = "/oauth2/callback/*";
    private final HttpCookieOAuth2AuthorizationRequestRepository httpCookieOAuth2AuthorizationRequestRepository;
    private final CustomOAuth2UserService customOAuth2UserService;
    private final ClientRegistrationRepository clientRegistrationRepository;
    private final OAuth2AuthenticationSuccessHandler oAuth2AuthenticationSuccessHandler;
    private final OAuth2AuthenticationFailureHandler oAuth2AuthenticationFailureHandler;
    @Autowired
    private JwtAuthenticationFilter jwtAuthenticationFilter;
    @Autowired
    private AuthenticationProvider authenticationProvider;
    private static final String[] AUTH_ENDPOINTS_PUBLIC = {
            "/api/auth/login",
            "/api/auth/greet",
            "/api/auth/register",
            "/api/auth/check-login",
            "/api/auth/login/oauth",
    };

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
                .cors(Customizer.withDefaults())
                .authorizeHttpRequests(authConfig -> {
                    authConfig.requestMatchers(AUTH_ENDPOINTS_PUBLIC).permitAll();
                    authConfig.requestMatchers("/private").hasRole("USER");
                    authConfig.requestMatchers("/api/profiles").hasAnyRole("USER", "ADMIN",
                            "SPECIALIST");
                    authConfig.requestMatchers("/api/profiles/**").hasAnyRole("USER", "ADMIN",
                            "SPECIALIST");
                    authConfig.requestMatchers("/api/specialist/**").hasAnyRole("ADMIN",
                            "SPECIALIST");
                    authConfig.requestMatchers("/api/bookings/**").hasAnyRole("ADMIN", "USER",
                            "SPECIALIST");
                    authConfig.requestMatchers("/api/schedules/**").hasAnyRole("ADMIN",
                            "SPECIALIST");
                    authConfig.requestMatchers("/api/schedule/**").hasAnyRole("ADMIN",
                            "SPECIALIST");
                    authConfig.requestMatchers("/api/payments/**").hasAnyRole("ADMIN", "USER",
                            "SPECIALIST");
                    authConfig.requestMatchers("/api/clinicalHistory-histories").hasAnyRole("ADMIN",
                            "SPECIALIST");
                    authConfig.requestMatchers("/api/clinical-records").hasAnyRole("ADMIN",
                            "SPECIALIST");
                    authConfig.anyRequest().denyAll();
                })
                .oauth2Login(oauth2 -> oauth2
                        .authorizationEndpoint(
                                authorizationEndpointConfig -> authorizationEndpointConfig
                                        .baseUri(OAUTH2_BASE_URI)
                                        .authorizationRequestRepository(
                                                httpCookieOAuth2AuthorizationRequestRepository)
                                        .authorizationRequestResolver(
                                                new CustomAuthorizationRequestResolver(
                                                        clientRegistrationRepository,
                                                        OAUTH2_BASE_URI)))
                        .redirectionEndpoint(
                                redirectionEndpointConfig -> redirectionEndpointConfig
                                        .baseUri(OAUTH2_REDIRECTION_ENDPOINT))
                        .userInfoEndpoint(userInfoEndpointConfig -> userInfoEndpointConfig
                                .userService(customOAuth2UserService))
                        .tokenEndpoint(tokenEndpointConfig -> tokenEndpointConfig
                                .accessTokenResponseClient(
                                        authorizationCodeTokenResponseClient()))
                        .successHandler(oAuth2AuthenticationSuccessHandler)
                        .failureHandler(oAuth2AuthenticationFailureHandler))
                .exceptionHandling(exceptionHandling -> exceptionHandling
                                .accessDeniedHandler(accessDeniedHandler()) // Custom handler for access
                                // denied
                                .authenticationEntryPoint(authenticationEntryPoint()) // Custom entry
                        // point for
                        // authentication
                        // errors
                )
                .csrf(AbstractHttpConfigurer::disable)
                .sessionManagement(session -> session
                        .sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .authenticationProvider(authenticationProvider)
                .addFilterBefore(jwtAuthenticationFilter,
                        UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }

}
